<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>Личный блог Анциферова Германа</title>

    <link href="/stylesheets/application.css" rel="stylesheet" type="text/css" media="all" />
    <link href="/stylesheets/highlighting.css" rel="stylesheet" type="text/css" />

    <script src="/javascripts/application.js" type="text/javascript"></script>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/posts/feed.xml" />
  </head>
  <body>

    <div class="wrapper">
      <header class="header">
  <div class="container header__content">
    <div class="user-photo header__user-photo">
<a class="user-photo__link" href="/">        <img class="user-photo__image" src="/images/avatar.png" />
</a>    </div>
    <div class="user-vcard header__user-vcard">
      <div class="user-vcard__name">Анциферов Герман</div>
      <div class="user-vcard__short-bio">
        Привет, мир! Пишу о себе, программировании и о чем-то еще ...
      </div>
    </div>
  </div>
</header>


      <section class="blog container">
        <div class="blog__aside">
          <nav class="menu">
<a class="menu-item selected" href="/posts/categories/Новости.html">      Новости
      <span class="counter">15</span>
</a><a class="menu-item " href="/posts/categories/linux.html">      Linux
      <span class="counter">2</span>
</a><a class="menu-item " href="/posts/categories/ruby.html">      Ruby
      <span class="counter">1</span>
</a><a class="menu-item " href="/posts/categories/Алгоритмы.html">      Алгоритмы
      <span class="counter">5</span>
</a><a class="menu-item " href="/posts/categories/cuda.html">      Cuda
      <span class="counter">1</span>
</a><a class="menu-item " href="/posts/categories/monit.html">      Monit
      <span class="counter">1</span>
</a></nav>

        </div>
        <div class="blog__content">
            <article class="article">
      <h2 class="title article__title">
    <a href="/"><span class="octicon octicon-home title__home"></span></a>
    <span>&raquo;</span>
    <span class="title__article">Установка CUDA под Linux</span>
  </h2>


  <ul class="meta">
  <li class="meta__item">
    <span class="octicon octicon-calendar"></span>
    December 16, 2012
  </li>
    <li class="meta__item">
      <span class="octicon octicon-file-directory"></span>
        <span class="comma"><a class="meta__link" href="/posts/categories/Новости.html">Новости</a></span>
        <span class="comma"><a class="meta__link" href="/posts/categories/cuda.html">CUDA</a></span>
        <span class="comma"><a class="meta__link" href="/posts/categories/linux.html">Linux</a></span>
    </li>
</ul>


  <div class="article__body markdown-body">
    <p>Давайте рассмотрим пример по установке CUDA под Linux. Для примера возьмем сырой дистрибутив OpenSuse (только что установленный на жесткий диск) и проделаем все операции по установке, настройке и сборке первого проекта на CUDA.</p>

<p>Для начала следует обновить дистрибутив OpenSuse до самых свежих и стабильных пакетов на текущей момент. Совет очень важный, так как порой при установке драйвера nvidia требуется пакет kernel-devel. Несовпадение пакета необходимый для драйвера nvidia с пакетом который установлен у вас в системе может повлечь к сбою в установке драйвера.</p>

<p>По умолчанию в дистрибутиве OpenSuse стоит бесплатный видеодрайвер nouveau, который необходимо занести в черный список:</p>
<pre class="highlight shell">  sudo <span class="nb">echo</span> -e <span class="s2">&quot;blacklist nouveau</span><span class="se">\\</span><span class="s2">noptions nouveau modeset=0&quot;</span> &gt;&gt; /etc/modprobe.d/50-blacklist.conf
</pre>
<p>Теперь нам необходимо узнать какая у нас видеокарта:</p>

<p><code>bash /sbin/lspci | grep -i vga</code></p>

<p>В итоге вы должны получить похожую строчку:</p>
<pre class="highlight shell">  01:00.0 VGA compatible controller: nVidia Corporation GT216 <span class="o">[</span>GeForce GT 240M] <span class="o">(</span>rev a2<span class="o">)</span>
</pre>
<p></p>

<p>Как видите я являюсь обладателем недорогой видеокарты GeForce GT240M. Теперь заходим на сайт <a href="http://www.nvidia.ru/Download/index.aspx?lang=ru">nvidia</a> и скачиваем драйвер под свою видеокарту.</p>

<p>В итоге мы получим файл NVIDIA-Linux-<strong>-</strong>.**.run. Перед установкой нам необходимо установить необходимые пакеты (компилятор и пакет разработчика для ядра):</p>
<pre class="highlight cpp"><span class="n">zypper</span> <span class="n">in</span> <span class="n">kernel</span><span class="o">-</span><span class="n">devel</span> <span class="n">gcc</span>
</pre>
<p>Теперь нам необходимо остановить иксы:</p>
<pre class="highlight cpp"><span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">xdm</span> <span class="n">stop</span>
</pre>
<p>И начать установку драйвера:</p>
<pre class="highlight cpp"><span class="n">sudo</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="n">NVIDIA</span><span class="o">-</span><span class="n">Linux</span><span class="o">-**-**</span><span class="p">.</span><span class="o">**</span><span class="p">.</span><span class="n">run</span>
<span class="n">sudo</span> <span class="p">.</span><span class="o">/</span><span class="n">NVIDIA</span><span class="o">-</span><span class="n">Linux</span><span class="o">-**-**</span><span class="p">.</span><span class="o">**</span><span class="p">.</span><span class="n">run</span>
</pre>
<p>Теперь можно перезагрузить систему и проверить, что драйвер установлен:</p>
<pre class="highlight cpp"><span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">X11</span><span class="o">/</span><span class="n">xorg</span><span class="p">.</span><span class="n">conf</span> <span class="o">|</span> <span class="n">grep</span> <span class="s">&quot;Driver&quot;</span>
</pre>
<p>Осталось установить CUDA. Для начала с сайта <a href="https://developer.nvidia.com/cuda-toolkit-archive">nvidia</a> скачиваем файл CUDA Toolkit, который содержит все необходимое для написания и запуска программ на CUDA. Вместе с CUDA Toolkit скачивают файл GPU Computing SDK code samples, который содержит кучу примеров для изучения технологии CUDA.</p>

<p>Установку CUDA начнем с файла CUDA Toolkit:</p>
<pre class="highlight cpp"><span class="n">sudo</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="n">cudatoolkit_</span><span class="o">**</span><span class="p">.</span><span class="n">run</span>
<span class="n">sudo</span> <span class="p">.</span><span class="o">/</span><span class="n">cudatoolkit_</span><span class="o">**</span><span class="p">.</span><span class="n">run</span>
</pre>
<p>Программа предложит вам путь куда установить ПО для CUDA. Лучше оставить путь по умолчанию: <code>cpp /usr/local/</code>.</p>

<p>Аналогично проделываем операцию по установке GPU Computing SDK code samples. Теперь можно написать первую программу&hellip; но наш компьютер не видит компилятор nvcc, поэтому добавим пути в переменное окружение (добавить строки в файл ~/.profile):</p>
<pre class="highlight cpp"><span class="k">export</span> <span class="n">PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="nl">bin:</span><span class="err">$</span><span class="n">PATH</span>
<span class="k">export</span> <span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="nl">lib:</span><span class="err">$</span><span class="n">LD_LIBRARY_PATH</span>
</pre>
<p>Внимание! Если у вас 64 разрядная система, то указываем путь до папки lib64</p>
<pre class="highlight cpp"><span class="k">export</span> <span class="n">LD_LIBRARY_PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">cuda</span><span class="o">/</span><span class="nl">lib64:</span><span class="err">$</span><span class="n">LD_LIBRARY_PATH</span>
</pre>
<p>Теперь можно написать первую программу, которую пишут на всех языках:</p>
<pre class="highlight cpp"><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">__global__</span> <span class="kt">void</span> <span class="n">HelloCUDA</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">result</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">){</span>

  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">p_HelloCUDA</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Hello CUDA!&quot;</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_HelloCUDA</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>

  <span class="kt">char</span>  <span class="o">*</span><span class="n">device_result</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span>  <span class="n">host_result</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

  <span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">device_result</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="mi">11</span><span class="p">);</span>

  <span class="n">HelloCUDA</span><span class="o">&lt;&lt;&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">device_result</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>

  <span class="n">cudaThreadSynchronize</span><span class="p">();</span>

  <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">host_result</span><span class="p">,</span> <span class="n">device_result</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="mi">11</span><span class="p">,</span> <span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>

  <span class="n">cudaFree</span><span class="p">(</span><span class="n">device_result</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host_result</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<p>Для компиляции и запуска программы необходимо:</p>
<pre class="highlight cpp"><span class="n">nvcc</span> <span class="n">hello</span><span class="p">.</span><span class="n">cu</span> <span class="o">-</span><span class="n">o</span> <span class="n">hello</span><span class="p">.</span><span class="n">o</span>
 <span class="p">.</span><span class="o">/</span><span class="n">hello</span><span class="p">.</span><span class="n">o</span>
</pre>
<p>Код достаточно грубый, ведь мы не обратываем ошибки при вызове функций CUDA. Для этого лучше посмотреть примеры из CUDA SDK, где через макросы обрабатываются исключения. Но для этого необходимо указывать компилятору путь до заголовочного файла cutil_inline.h из CUDA SDK.</p>

<p>Для обучения добавлю еще пару примеров:</p>

<p><strong>Сложение векторов</strong>:</p>
<pre class="highlight cpp"><span class="cp">#include &lt;stdio.h&gt;
#include &lt;cuda_runtime_api.h&gt;
</span>
<span class="n">__global__</span> <span class="kt">void</span> <span class="n">sum</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span> <span class="n">A</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">B</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">C</span><span class="p">,</span> <span class="kt">int</span> <span class="n">N</span><span class="p">){</span>

    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">init</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="n">arr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">float</span> <span class="n">value</span><span class="p">){</span>

  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(){</span>

  <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">500000</span><span class="p">;</span>
  <span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>

  <span class="kt">float</span> <span class="o">*</span><span class="n">A</span><span class="p">,</span> <span class="o">*</span><span class="n">B</span><span class="p">,</span> <span class="o">*</span><span class="n">C</span><span class="p">;</span>
  <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
  <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
  <span class="n">C</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

  <span class="n">init</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="n">init</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="kt">float</span> <span class="o">*</span><span class="n">cudaA</span><span class="p">,</span> <span class="o">*</span><span class="n">cudaB</span><span class="p">,</span> <span class="o">*</span><span class="n">cudaC</span><span class="p">;</span>
  <span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cudaA</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cudaB</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cudaC</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

  <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">cudaA</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
  <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">cudaB</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>

  <span class="n">dim3</span> <span class="n">threads</span> <span class="o">=</span> <span class="n">dim3</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">dim3</span> <span class="n">blocks</span> <span class="o">=</span> <span class="n">dim3</span><span class="p">((</span><span class="n">N</span> <span class="o">+</span> <span class="n">threads</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">threads</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

  <span class="n">sum</span><span class="o">&lt;&lt;&lt;</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">threads</span> <span class="o">&gt;&gt;&gt;</span> <span class="p">(</span><span class="n">cudaA</span><span class="p">,</span> <span class="n">cudaB</span><span class="p">,</span> <span class="n">cudaC</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>

  <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">cudaC</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>

  <span class="kt">float</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">sum</span> <span class="o">+=</span> <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Summa %f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sum</span><span class="p">);</span>

  <span class="n">free</span><span class="p">(</span><span class="n">A</span><span class="p">);</span> <span class="n">free</span><span class="p">(</span><span class="n">B</span><span class="p">);</span> <span class="n">free</span><span class="p">(</span><span class="n">C</span><span class="p">);</span>
  <span class="n">cudaFree</span><span class="p">(</span><span class="n">cudaA</span><span class="p">);</span> <span class="n">cudaFree</span><span class="p">(</span><span class="n">cudaB</span><span class="p">);</span> <span class="n">cudaFree</span><span class="p">(</span><span class="n">cudaC</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre>
<p><strong>Транспонирование матрицы</strong>:</p>
<pre class="highlight cpp"><span class="cp">#include &lt;stdio.h&gt;
#include &lt;cuda_runtime_api.h&gt;
</span>
<span class="n">__global__</span> <span class="kt">void</span> <span class="n">trans</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">A</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">B</span><span class="p">,</span> <span class="kt">int</span> <span class="n">N</span><span class="p">){</span>

  <span class="kt">int</span> <span class="n">xIndex</span> <span class="o">=</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">yIndex</span> <span class="o">=</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>

  <span class="kt">int</span> <span class="n">inIndex</span> <span class="o">=</span> <span class="n">xIndex</span> <span class="o">+</span> <span class="n">N</span> <span class="o">*</span> <span class="n">yIndex</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">outIndex</span> <span class="o">=</span> <span class="n">yIndex</span> <span class="o">+</span> <span class="n">N</span> <span class="o">*</span> <span class="n">xIndex</span><span class="p">;</span>

  <span class="n">B</span><span class="p">[</span><span class="n">inIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">outIndex</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">init</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">arr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">){</span>

  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
      <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">size</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">print</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">arr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">){</span>

  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">size</span><span class="o">+</span><span class="n">j</span><span class="p">]);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(){</span>

  <span class="kt">int</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">block</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

  <span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">N</span><span class="o">*</span><span class="n">N</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>

  <span class="kt">int</span> <span class="o">*</span><span class="n">A</span><span class="p">,</span> <span class="o">*</span><span class="n">B</span><span class="p">;</span>
  <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
  <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

  <span class="n">init</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>
  <span class="n">print</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>

  <span class="kt">int</span> <span class="o">*</span><span class="n">cudaA</span><span class="p">,</span> <span class="o">*</span><span class="n">cudaB</span><span class="p">;</span>
  <span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cudaA</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cudaB</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

  <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">cudaA</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>

  <span class="n">dim3</span> <span class="n">threads</span> <span class="o">=</span> <span class="n">dim3</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">block</span><span class="p">);</span>
  <span class="n">dim3</span> <span class="n">blocks</span> <span class="o">=</span> <span class="n">dim3</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="n">threads</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">N</span> <span class="o">/</span> <span class="n">threads</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>

  <span class="n">trans</span><span class="o">&lt;&lt;&lt;</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">threads</span> <span class="o">&gt;&gt;&gt;</span> <span class="p">(</span><span class="n">cudaA</span><span class="p">,</span> <span class="n">cudaB</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>

  <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">cudaB</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>

  <span class="n">print</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">N</span><span class="p">);</span>

  <span class="n">free</span><span class="p">(</span><span class="n">A</span><span class="p">);</span> <span class="n">free</span><span class="p">(</span><span class="n">B</span><span class="p">);</span>
  <span class="n">cudaFree</span><span class="p">(</span><span class="n">cudaA</span><span class="p">);</span> <span class="n">cudaFree</span><span class="p">(</span><span class="n">cudaB</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>
  </div>

  

</article>

<div class="comments article__comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES * * */
      var disqus_shortname = 'german-antsiferov';

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>


        </div>
      </section>
    </div>

    <footer class="footer">
  <p>
    <span class="copyright footer__copyright">
      Copyright &copy; 2018 Анциферов Герман
    </span>
  </p>
</footer>

    <!-- Yandex.Metrika counter --><script type="text/javascript"> (function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter32769165 = new Ya.Metrika({ id:32769165, clickmap:true, trackLinks:true, accurateTrackBounce:true, webvisor:true }); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = "https://mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="https://mc.yandex.ru/watch/32769165" style="position:absolute; left:-9999px;" alt="" /></div></noscript><!-- /Yandex.Metrika counter -->

  </body>
</html>
