<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>Личный блог Анциферова Германа</title>

    <link href="/stylesheets/application.css" rel="stylesheet" media="all" />
    <link href="/stylesheets/highlighting.css" rel="stylesheet" />

    <script src="/javascripts/application.js"></script>
  </head>
  <body>

    <div class="wrapper">
      <header class="header">
  <div class="container header__content">
    <div class="user-photo header__user-photo">
<a href="/" class="user-photo__link">        <img src="/images/avatar.png" class="user-photo__image" alt="" />
</a>    </div>
    <div class="user-vcard header__user-vcard">
      <div class="user-vcard__name">Анциферов Герман</div>
      <div class="user-vcard__short-bio">
        Привет, мир! Пишу о себе, программировании и о чем-то еще ...
      </div>
    </div>
  </div>
</header>


      <section class="blog container">
        <div class="blog__aside">
          <nav class="menu">
<a href="/posts/categories/%D0%9D%D0%BE%D0%B2%D0%BE%D1%81%D1%82%D0%B8.html" class="menu-item selected">      Новости
      <span class="counter">15</span>
</a><a href="/posts/categories/monit.html" class="menu-item ">      Monit
      <span class="counter">1</span>
</a><a href="/posts/categories/ruby.html" class="menu-item ">      Ruby
      <span class="counter">1</span>
</a><a href="/posts/categories/linux.html" class="menu-item ">      Linux
      <span class="counter">2</span>
</a><a href="/posts/categories/cuda.html" class="menu-item ">      Cuda
      <span class="counter">1</span>
</a><a href="/posts/categories/%D0%90%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC%D1%8B.html" class="menu-item ">      Алгоритмы
      <span class="counter">5</span>
</a></nav>

        </div>
        <div class="blog__content">
            <article class="article">
      <h2 class="title article__title">
    <a href="/"><span class="octicon octicon-home title__home"></span></a>
    <span>&raquo;</span>
    <span class="title__article">Рисуем комиксы</span>
  </h2>


  <ul class="meta">
  <li class="meta__item">
    <span class="octicon octicon-calendar"></span>
    January 08, 2012
  </li>
    <li class="meta__item">
      <span class="octicon octicon-file-directory"></span>
        <span class="comma"><a href="/posts/categories/%D0%9D%D0%BE%D0%B2%D0%BE%D1%81%D1%82%D0%B8.html" class="meta__link">Новости</a></span>
        <span class="comma"><a href="/posts/categories/%D0%90%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC%D1%8B.html" class="meta__link">Алгоритмы</a></span>
    </li>
</ul>


  <div class="article__body markdown-body">
    <p>Вот и пролетели новогодние праздники&hellip;</p>

<p>Все встречают новый год по-разному&hellip;</p>

<p>Но можно предположить, что алгоритм &ldquo;Встречи нового года&rdquo; у всех примерно такой: застолье, танцы, песни, поздравление близких и друзей&hellip;
Вот и я хочу всех поздравить с Новым 2012 годом и процитировать очень запомнившиеся для меня поздравление от Афанасьевой Евгении:  &ldquo;Успехов вам, проектов интересных, здоровья и любви! :-)</p>

<p>Хочу предложить первый интересный для меня проект - это Cartoon Filter или как я его называю - мультяшный фильтр. Маленькая часть из моего диплома.

Доступно разъясненный алгоритм было очень сложно найти в интернете, поэтому пришлось поднимать исходники различных проектов с реализацией данного алгоритма. И удача была на моей стороне&hellip; Оказывается исходники графического редактора GIMP очень хорошо не только написаны, но и подробно прокомментированы.</p>

<p>Если не верите, то можете смело скачать исходники с официального сайта и найти файл <code>gimp-2.6.9/plug-ins/common/cartoon.c</code>. Алгоритм очень простой:</p>
<div class="highlight"><pre class="highlight c"><code><span class="cm">/*
 * Cartoon algorithm
 * -----------------
 * Mask radius = radius of pixel neighborhood for intensity comparison
 * Threshold   = relative intensity difference which will result in darkening
 * Ramp        = amount of relative intensity difference before total black
 * Blur radius = mask radius / 3.0
 *
 * Algorithm:
 * For each pixel, calculate pixel intensity value to be: avg (blur radius)
 * relative diff = pixel intensity / avg (mask radius)
 * If relative diff &lt; Threshold
 *   intensity mult = (Ramp - MIN (Ramp, (Threshold - relative diff))) / Ramp
 *   pixel intensity *= intensity mult
 */</span>
</code></pre></div>
<p>Моя первая реализация алгоритма:</p>
<div class="highlight"><pre class="highlight c"><code><span class="kt">void</span> <span class="n">ComicsFilter</span><span class="o">::</span><span class="n">cartoon</span><span class="p">(</span><span class="n">QImage</span> <span class="o">*</span><span class="n">image</span><span class="p">){</span>

    <span class="kt">double</span> <span class="n">size</span> <span class="o">=</span> <span class="n">m_mask_radius</span> <span class="o">*</span> <span class="n">m_mask_radius</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">center</span> <span class="o">=</span> <span class="n">m_mask_radius</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">m_image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">()</span> <span class="o">-</span> <span class="n">center</span><span class="p">,</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">m_image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">()</span> <span class="o">-</span> <span class="n">center</span><span class="p">,</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">m_mask_radius</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">center</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="o">++</span><span class="n">x</span><span class="p">)</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">center</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">height</span><span class="p">;</span> <span class="o">++</span><span class="n">y</span><span class="p">){</span>

            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="kt">double</span> <span class="n">sumR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sumB</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sumG</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">iX</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">top</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m_mask_radius</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span><span class="o">++</span><span class="n">iX</span><span class="p">){</span>

                <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">iY</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">top</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">m_mask_radius</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">,</span><span class="o">++</span><span class="n">iY</span><span class="p">){</span>

                    <span class="n">sumR</span> <span class="o">+=</span> <span class="n">qRed</span><span class="p">(</span><span class="n">m_image</span><span class="o">-&gt;</span><span class="n">pixel</span><span class="p">(</span><span class="n">iX</span><span class="p">,</span><span class="n">iY</span><span class="p">));</span>
                    <span class="n">sumB</span> <span class="o">+=</span> <span class="n">qBlue</span><span class="p">(</span><span class="n">m_image</span><span class="o">-&gt;</span><span class="n">pixel</span><span class="p">(</span><span class="n">iX</span><span class="p">,</span><span class="n">iY</span><span class="p">));</span>
                    <span class="n">sumG</span> <span class="o">+=</span> <span class="n">qGreen</span><span class="p">(</span><span class="n">m_image</span><span class="o">-&gt;</span><span class="n">pixel</span><span class="p">(</span><span class="n">iX</span><span class="p">,</span><span class="n">iY</span><span class="p">));</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">sumR</span> <span class="o">/=</span> <span class="n">size</span><span class="p">;</span>
            <span class="n">sumB</span> <span class="o">/=</span> <span class="n">size</span><span class="p">;</span>
            <span class="n">sumG</span> <span class="o">/=</span> <span class="n">size</span><span class="p">;</span>

            <span class="c1">//image-&gt;setPixel(x,y,qRgb(sumR,sumB,sumG));</span>

            <span class="kt">double</span> <span class="n">red</span> <span class="o">=</span> <span class="n">qRed</span><span class="p">(</span><span class="n">m_image</span><span class="o">-&gt;</span><span class="n">pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)),</span>
                    <span class="n">blue</span> <span class="o">=</span> <span class="n">qBlue</span><span class="p">(</span><span class="n">m_image</span><span class="o">-&gt;</span><span class="n">pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)),</span>
                    <span class="n">green</span> <span class="o">=</span> <span class="n">qGreen</span><span class="p">(</span><span class="n">m_image</span><span class="o">-&gt;</span><span class="n">pixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">));</span>

            <span class="kt">double</span> <span class="n">koeffR</span> <span class="o">=</span> <span class="n">red</span> <span class="o">/</span> <span class="n">sumR</span><span class="p">,</span>
                    <span class="n">koeffB</span> <span class="o">=</span> <span class="n">blue</span> <span class="o">/</span> <span class="n">sumB</span><span class="p">,</span>
                    <span class="n">koeffG</span> <span class="o">=</span> <span class="n">green</span> <span class="o">/</span> <span class="n">sumG</span><span class="p">;</span>

            <span class="k">if</span><span class="p">(</span><span class="n">koeffR</span> <span class="o">&lt;</span> <span class="n">m_threshold</span><span class="p">)</span>
                <span class="n">red</span> <span class="o">*=</span> <span class="p">((</span><span class="n">m_ramp</span> <span class="o">-</span> <span class="n">qMin</span><span class="p">(</span><span class="n">m_ramp</span><span class="p">,(</span><span class="n">m_threshold</span> <span class="o">-</span> <span class="n">koeffR</span><span class="p">)))</span><span class="o">/</span><span class="n">m_ramp</span><span class="p">);</span>


            <span class="k">if</span><span class="p">(</span><span class="n">koeffB</span> <span class="o">&lt;</span> <span class="n">m_threshold</span><span class="p">)</span>
                <span class="n">blue</span> <span class="o">*=</span> <span class="p">((</span><span class="n">m_ramp</span> <span class="o">-</span> <span class="n">qMin</span><span class="p">(</span><span class="n">m_ramp</span><span class="p">,(</span><span class="n">m_threshold</span> <span class="o">-</span> <span class="n">koeffB</span><span class="p">)))</span><span class="o">/</span><span class="n">m_ramp</span><span class="p">);</span>


            <span class="k">if</span><span class="p">(</span><span class="n">koeffG</span> <span class="o">&lt;</span> <span class="n">m_threshold</span><span class="p">)</span>
                <span class="n">green</span> <span class="o">*=</span> <span class="p">((</span><span class="n">m_ramp</span> <span class="o">-</span> <span class="n">qMin</span><span class="p">(</span><span class="n">m_ramp</span><span class="p">,(</span><span class="n">m_threshold</span> <span class="o">-</span> <span class="n">koeffG</span><span class="p">)))</span><span class="o">/</span><span class="n">m_ramp</span><span class="p">);</span>

            <span class="n">image</span><span class="o">-&gt;</span><span class="n">setPixel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">qRgb</span><span class="p">(</span><span class="n">red</span><span class="p">,</span><span class="n">green</span><span class="p">,</span><span class="n">blue</span><span class="p">));</span>
        <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>За основу подойдет любой сглаживающий фильтр. В моем примере я взял <a href="http://www.pcigeomatics.com/cgi-bin/pcihlp/IWORKS%7CFilter%7CAverage+Filter">усредненный фильтр</a>, а программисты GIMP используют фильтр Гаусса. Фильтром Гаусса сначало идут по столбцам, а затем по строкам и благодаря двум проходам автоматически вычисляют коэффициент затемнения dump:</p>
<div class="highlight"><pre class="highlight c"><code><span class="cm">/**
  @param dest1 по столбцам
  @param dest2 по строкам
  @param length размер изображения (width*height)
  @param pct_black процент затемнения
*/</span>
<span class="k">static</span> <span class="n">gdouble</span>
<span class="nf">compute_ramp</span> <span class="p">(</span><span class="n">guchar</span>  <span class="o">*</span><span class="n">dest1</span><span class="p">,</span>
              <span class="n">guchar</span>  <span class="o">*</span><span class="n">dest2</span><span class="p">,</span>
              <span class="n">gint</span>     <span class="n">length</span><span class="p">,</span>
              <span class="n">gdouble</span>  <span class="n">pct_black</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">gint</span>    <span class="n">hist</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
  <span class="n">gdouble</span> <span class="n">diff</span><span class="p">;</span>
  <span class="n">gint</span>    <span class="n">count</span><span class="p">;</span>
  <span class="n">gint</span>    <span class="n">i</span><span class="p">;</span>
  <span class="n">gint</span>    <span class="n">sum</span><span class="p">;</span>

  <span class="n">memset</span> <span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
  <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dest2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">gdouble</span><span class="p">)</span> <span class="o">*</span><span class="n">dest1</span> <span class="o">/</span> <span class="p">(</span><span class="n">gdouble</span><span class="p">)</span> <span class="o">*</span><span class="n">dest2</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">hist</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">diff</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
              <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

      <span class="n">dest1</span><span class="o">++</span><span class="p">;</span>
      <span class="n">dest2</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">pct_black</span> <span class="o">==</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span> <span class="o">||</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

  <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">sum</span> <span class="o">+=</span> <span class="n">hist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(((</span><span class="n">gdouble</span><span class="p">)</span> <span class="n">sum</span> <span class="o">/</span> <span class="p">(</span><span class="n">gdouble</span><span class="p">)</span> <span class="n">count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pct_black</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="o">-</span> <span class="p">(</span><span class="n">gdouble</span><span class="p">)</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">100</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div>
<p>Если немножко заглянуть в будущее, то данный алгоритм переведу на CUDA, думаю это не должно вызвать сложностей, ведь реализации фильтра Гаусса и фильтра с использованием ядра можно найти в примерах CUDA SDK, а также &quot;мультяшный&rdquo; фильтр попробуем применить к видео файлам.</p>

<p>Предлагаю посмотреть на реализацию данного алгоритма. Cartoon filter с параметрами: radius = 23, threshold = 1.0, ramp = 0.15. Если приловчиться с входными параметрами, то можно сделать очень забавные комиксы :-)</p>

<p><img src="/posts/2012/01/08/risuem-komiksy/car.jpeg" alt="Исходное изображение" /></p>

<p><img src="/posts/2012/01/08/risuem-komiksy/cartoon_car.jpeg" alt="Исходное изображение" /></p>

  </div>

  

</article>

<div class="comments article__comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES * * */
      var disqus_shortname = 'german-antsiferov';

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>


        </div>
      </section>
    </div>

    <footer class="footer">
  <p>
    <span class="copyright footer__copyright">
      Copyright &copy; 2011 &mdash; 2022 Анциферов Герман
    </span>
  </p>
</footer>

    <!-- Yandex.Metrika counter --><script type="text/javascript"> (function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter32769165 = new Ya.Metrika({ id:32769165, clickmap:true, trackLinks:true, accurateTrackBounce:true, webvisor:true }); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = "https://mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="https://mc.yandex.ru/watch/32769165" style="position:absolute; left:-9999px;" alt="" /></div></noscript><!-- /Yandex.Metrika counter -->

  </body>
</html>
