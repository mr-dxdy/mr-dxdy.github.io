<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>Личный блог Анциферова Германа</title>

    <link href="/stylesheets/application.css" rel="stylesheet" media="all" />
    <link href="/stylesheets/highlighting.css" rel="stylesheet" />

    <script src="/javascripts/application.js"></script>
  </head>
  <body>

    <div class="wrapper">
      <header class="header">
  <div class="container header__content">
    <div class="user-photo header__user-photo">
<a href="/" class="user-photo__link">        <img src="/images/avatar.png" class="user-photo__image" alt="Avatar" />
</a>    </div>
    <div class="user-vcard header__user-vcard">
      <div class="user-vcard__name">Анциферов Герман</div>
      <div class="user-vcard__short-bio">
        Привет, мир! Пишу о себе, программировании и о чем-то еще ...
      </div>
    </div>
  </div>
</header>


      <section class="blog container">
        <div class="blog__aside">
          <nav class="menu">
<a href="/posts/categories/%D0%9D%D0%BE%D0%B2%D0%BE%D1%81%D1%82%D0%B8.html" class="menu-item selected">      Новости
      <span class="counter">15</span>
</a><a href="/posts/categories/monit.html" class="menu-item ">      Monit
      <span class="counter">1</span>
</a><a href="/posts/categories/ruby.html" class="menu-item ">      Ruby
      <span class="counter">1</span>
</a><a href="/posts/categories/linux.html" class="menu-item ">      Linux
      <span class="counter">2</span>
</a><a href="/posts/categories/cuda.html" class="menu-item ">      Cuda
      <span class="counter">1</span>
</a><a href="/posts/categories/%D0%90%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC%D1%8B.html" class="menu-item ">      Алгоритмы
      <span class="counter">5</span>
</a></nav>

        </div>
        <div class="blog__content">
            <article class="article">
      <h2 class="title article__title">
    <a href="/"><span class="octicon octicon-home title__home"></span></a>
    <span>&raquo;</span>
    <span class="title__article">Настройка monit</span>
  </h2>


  <ul class="meta">
  <li class="meta__item">
    <span class="octicon octicon-calendar"></span>
    August 28, 2018
  </li>
    <li class="meta__item">
      <span class="octicon octicon-file-directory"></span>
        <span class="comma"><a href="/posts/categories/%D0%9D%D0%BE%D0%B2%D0%BE%D1%81%D1%82%D0%B8.html" class="meta__link">Новости</a></span>
        <span class="comma"><a href="/posts/categories/monit.html" class="meta__link">Monit</a></span>
    </li>
</ul>


  <div class="article__body markdown-body">
    <p>Заходим по ssh на сервер: <code>ssh user@your-server</code></p>

<p>Устанавливаем приложение monit: <code>sudo apt-get install monit</code></p>

<p>Открываем доступ к админке через http:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nb">sudo </span>vim /etc/monit/monitrc
</code></pre></div>
<p>Находим раздел и редактируем:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nb">set </span>httpd port 2812 and
    use address your-server
    allow 0.0.0.0/0.0.0.0
    allow admin:monit
</code></pre></div>
<p>Перезагружаем службу <code>sudo service monit reload</code>. Проверяем работоспособность админки: <code>http://your-server:2812</code></p>

<p></p>

<p>Редактируем раздел, откуда брать конфиги:</p>
<div class="highlight"><pre class="highlight shell"><code><span class="c">#   include /etc/monit/conf.d/*</span>
include /etc/monit/conf-enabled/<span class="k">*</span>
</code></pre></div>
<p>Напишем конфиг для запуска службы. Хранение конфигов схоже с продуктом nginx.
Все конфиги  надо складывать в папку <code>/etc/monit/conf-available</code> и делать линки на эти конфиги в папку <code>/etc/monit/conf-enabled</code>.<br>
Для многих известных служб уже написаны конфиги. Их можно найти <a href="https://mmonit.com/wiki/Monit/ConfigurationExamples">тут</a>.</p>

<p>У Monit свой DSL для написания конфигов, который очень легко читать (подробнее <a href="https://mmonit.com/monit/documentation/monit.html#GENERAL-SYNTAX">тут</a>). Пример конфига для postgresql:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="n">check</span> <span class="n">process</span> <span class="n">postgresql</span> <span class="n">with</span> <span class="n">pidfile</span> <span class="sr">/var/</span><span class="n">run</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="mf">9.6</span><span class="o">-</span><span class="n">main</span><span class="p">.</span><span class="nf">pid</span>
  <span class="n">group</span> <span class="n">database</span>
  <span class="n">start</span> <span class="n">program</span> <span class="o">=</span> <span class="s2">"/etc/init.d/postgresql start"</span>
  <span class="n">stop</span>  <span class="n">program</span> <span class="o">=</span> <span class="s2">"/etc/init.d/postgresql stop"</span>
  <span class="k">if</span> <span class="n">failed</span> <span class="n">host</span> <span class="n">localhost</span> <span class="n">port</span> <span class="mi">5432</span> <span class="n">protocol</span> <span class="n">pgsql</span> <span class="k">then</span> <span class="n">restart</span>
  <span class="k">if</span> <span class="mi">5</span> <span class="n">restarts</span> <span class="n">with</span> <span class="mi">5</span> <span class="n">cycles</span> <span class="k">then</span> <span class="n">timeout</span>
</code></pre></div>
<p>Теперь проверим, что конфиг - валидный: <code>sudo monit -t</code>.
Если синтаксис корректный, то перезагружаем monit: <code>sudo monit reload</code>.</p>

<p>Теперь напишем конфиг для запуска сервера Puma:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="n">check</span> <span class="n">process</span> <span class="n">your</span><span class="o">-</span><span class="n">app</span><span class="o">-</span><span class="n">puma</span> <span class="n">with</span> <span class="n">pidfile</span> <span class="sr">/srv/</span><span class="n">www</span><span class="o">/</span><span class="n">your</span><span class="o">-</span><span class="n">app</span><span class="o">/</span><span class="n">shared</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pids</span><span class="o">/</span><span class="n">puma</span><span class="p">.</span><span class="nf">pid</span>
  <span class="n">group</span> <span class="n">site</span>
  <span class="n">start</span> <span class="n">program</span> <span class="o">=</span> <span class="s2">"/bin/su - user -c 'cd /srv/www/your-app/current &amp;&amp; bundle exec pumactl -F /srv/www/your-app/shared/puma.rb start'"</span> <span class="n">with</span> <span class="n">timeout</span> <span class="mi">10</span> <span class="n">seconds</span>
  <span class="n">stop</span> <span class="n">program</span> <span class="o">=</span> <span class="s2">"/bin/su - user -c 'cd /srv/www/your-app/current &amp;&amp; bundle exec pumactl -F /srv/www/your-app/shared/puma.rb stop'"</span> <span class="n">with</span> <span class="n">timeout</span> <span class="mi">10</span> <span class="n">seconds</span>
  <span class="k">if</span> <span class="mi">3</span> <span class="n">restarts</span> <span class="n">within</span> <span class="mi">3</span> <span class="n">cycles</span> <span class="k">then</span> <span class="n">timeout</span>
</code></pre></div>
<p>Пример конфига для запуска gitlab-runner. Здесь проверка службы происходит не по pid, а по названию процесса:</p>
<div class="highlight"><pre class="highlight ruby"><code><span class="n">check</span> <span class="n">process</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">runner</span> <span class="n">matching</span> <span class="s2">"gitlab-runner"</span>
  <span class="n">group</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">ci</span>
  <span class="n">start</span>   <span class="n">program</span> <span class="o">=</span> <span class="s2">"/usr/sbin/service gitlab-runner start"</span>
  <span class="n">stop</span>    <span class="n">program</span> <span class="o">=</span> <span class="s2">"/usr/sbin/service gitlab-runner stop"</span>
  <span class="n">restart</span> <span class="n">program</span> <span class="o">=</span> <span class="s2">"/usr/sbin/service gitlab-runner restart"</span>
  <span class="k">if</span> <span class="mi">5</span> <span class="n">restarts</span> <span class="n">with</span> <span class="mi">5</span> <span class="n">cycles</span> <span class="k">then</span> <span class="n">timeout</span>
</code></pre></div>
<p>Источники:</p>

<ol>
<li><a href="https://mmonit.com/monit/documentation/monit.html">Официальная документация</a></li>
</ol>

  </div>

  

</article>

<div class="comments article__comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES * * */
      var disqus_shortname = 'german-antsiferov';

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>


        </div>
      </section>
    </div>

    <footer class="footer">
  <p>
    <span class="copyright footer__copyright">
      Copyright &copy; 2019 Анциферов Герман
    </span>
  </p>
</footer>

    <!-- Yandex.Metrika counter --><script type="text/javascript"> (function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter32769165 = new Ya.Metrika({ id:32769165, clickmap:true, trackLinks:true, accurateTrackBounce:true, webvisor:true }); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = "https://mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="https://mc.yandex.ru/watch/32769165" style="position:absolute; left:-9999px;" alt="" /></div></noscript><!-- /Yandex.Metrika counter -->

  </body>
</html>
